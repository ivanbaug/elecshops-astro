---

---
<div class="container mx-auto relative overflow-x-auto" style="height: calc(100vh - 60px - 74px);" >
  <table role="grid" class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0 z-50">
        <tr>
          <th scope="col" class="sm:px-6 py-3">
            <div class="flex items-center">
              SKU
              <button data-sort-by="sku" ><svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 ml-1" aria-hidden="true" fill="currentColor" viewBox="0 0 320 512"><path d="M27.66 224h264.7c24.6 0 36.89-29.78 19.54-47.12l-132.3-136.8c-5.406-5.406-12.47-8.107-19.53-8.107c-7.055 0-14.09 2.701-19.45 8.107L8.119 176.9C-9.229 194.2 3.055 224 27.66 224zM292.3 288H27.66c-24.6 0-36.89 29.77-19.54 47.12l132.5 136.8C145.9 477.3 152.1 480 160 480c7.053 0 14.12-2.703 19.53-8.109l132.3-136.8C329.2 317.8 316.9 288 292.3 288z"/></svg></button>
            </div>
          </th>
          <th scope="col" class="sm:px-6 py-3">
            <div class="flex items-center">
              Description
              <button data-sort-by="description" ><svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 ml-1" aria-hidden="true" fill="currentColor" viewBox="0 0 320 512"><path d="M27.66 224h264.7c24.6 0 36.89-29.78 19.54-47.12l-132.3-136.8c-5.406-5.406-12.47-8.107-19.53-8.107c-7.055 0-14.09 2.701-19.45 8.107L8.119 176.9C-9.229 194.2 3.055 224 27.66 224zM292.3 288H27.66c-24.6 0-36.89 29.77-19.54 47.12l132.5 136.8C145.9 477.3 152.1 480 160 480c7.053 0 14.12-2.703 19.53-8.109l132.3-136.8C329.2 317.8 316.9 288 292.3 288z"/></svg></button>
            </div>
            </th>
          <th scope="col" class="sm:px-6 py-3">
            <div class="flex items-center">
              Stock
              <button data-sort-by="stock" ><svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 ml-1" aria-hidden="true" fill="currentColor" viewBox="0 0 320 512"><path d="M27.66 224h264.7c24.6 0 36.89-29.78 19.54-47.12l-132.3-136.8c-5.406-5.406-12.47-8.107-19.53-8.107c-7.055 0-14.09 2.701-19.45 8.107L8.119 176.9C-9.229 194.2 3.055 224 27.66 224zM292.3 288H27.66c-24.6 0-36.89 29.77-19.54 47.12l132.5 136.8C145.9 477.3 152.1 480 160 480c7.053 0 14.12-2.703 19.53-8.109l132.3-136.8C329.2 317.8 316.9 288 292.3 288z"/></svg></button>
            </div>
          </th>
          <th scope="col" class="sm:px-6 py-3">
            <div class="flex items-center">
              Price
              <button data-sort-by="price" ><svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 ml-1" aria-hidden="true" fill="currentColor" viewBox="0 0 320 512"><path d="M27.66 224h264.7c24.6 0 36.89-29.78 19.54-47.12l-132.3-136.8c-5.406-5.406-12.47-8.107-19.53-8.107c-7.055 0-14.09 2.701-19.45 8.107L8.119 176.9C-9.229 194.2 3.055 224 27.66 224zM292.3 288H27.66c-24.6 0-36.89 29.77-19.54 47.12l132.5 136.8C145.9 477.3 152.1 480 160 480c7.053 0 14.12-2.703 19.53-8.109l132.3-136.8C329.2 317.8 316.9 288 292.3 288z"/></svg></button>
            </div>
          </th>
          <th scope="col" class="sm:px-6 py-3 hidden sm:block">
            <div class="flex items-center">
              Store
              <button data-sort-by="store" ><svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 ml-1" aria-hidden="true" fill="currentColor" viewBox="0 0 320 512"><path d="M27.66 224h264.7c24.6 0 36.89-29.78 19.54-47.12l-132.3-136.8c-5.406-5.406-12.47-8.107-19.53-8.107c-7.055 0-14.09 2.701-19.45 8.107L8.119 176.9C-9.229 194.2 3.055 224 27.66 224zM292.3 288H27.66c-24.6 0-36.89 29.77-19.54 47.12l132.5 136.8C145.9 477.3 152.1 480 160 480c7.053 0 14.12-2.703 19.53-8.109l132.3-136.8C329.2 317.8 316.9 288 292.3 288z"/></svg></button>
            </div>
          </th>
        </tr>
      </thead>
      <tbody id="tableBody" class="bg-white border-b dark:bg-gray-900 dark:border-gray-700" >
      </tbody>
    </table>
</div>
<script >

  import { Product, ProductResponseData, getProductData } from '../scripts/product';
  import { $paginationData, type PaginationData } from '../stores/paginationDataStore';
  import { $tableQueryParams, setTableOrder } from '../stores/tableQueryParamsStore'

  const tbody = document.getElementById("tableBody") as HTMLTableElement;

  function updateTable(products: Product[]) {
    if(tbody!=null) {
      tbody.innerHTML = "";
      const linkIcon = '&nbsp<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>';
      if (!products){
        const row = tbody.insertRow();
        row.className = "bg-white border-b dark:bg-gray-900 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600";
        const c0 = row.insertCell(0);
        c0.className = "sm:px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white";
        c0.innerHTML = 'No products to show.';
        return;
      }
      products.forEach((product, i:number) => {
          const row = tbody.insertRow(i);
          row.className = i % 2 === 0 ? "bg-white border-b dark:bg-gray-900 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" : "border-b bg-gray-50 dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600";
          const c0 = row.insertCell(0);
          const c1 = row.insertCell(1);
          const c2 = row.insertCell(2);
          const c3 = row.insertCell(3);
          const c4 = row.insertCell(4);
          c0.className = "sm:px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white";
          c0.innerHTML = '<a href="'+product.url+'" class="flex items-center font-bold visited:text-indigo-700 dark:visited:text-indigo-400" ><span>'+product.sku+'</span>'+linkIcon+'</a>';
          c1.innerHTML = product.description;
          c2.className = 'text-right pr-4'
          c2.innerHTML = ''+product.stock;
          c3.className = 'text-right pr-4'
          c3.innerHTML = '$ '+product.price.toLocaleString('en');
          c4.className = 'text-center hidden sm:table-cell'
          c4.innerHTML = ''+product.store_name;
      });
    } 
  }

  window.addEventListener('load', function() {
    refreshProductsTable(); // once page loads
  }, false);

  async function refreshProductsTable(){    
    if(tbody!=null) {
      const response : ProductResponseData = await getProductData();
      updateTable(response.data);

      const paginationData : PaginationData = {
        page: response.page,
        per_page: response.per_page,
        page_qty: response.page_qty,
        total: response.total,
      }
      $paginationData.set(paginationData); 
    }
  }
  
  if(tbody!=null) {
    const sortBtns = document.querySelectorAll("[data-sort-by]") as NodeListOf<HTMLElement>;
      sortBtns.forEach(b=> {
        b.addEventListener("click", ()=>{
          const col = b.getAttribute("data-sort-by") as string;
          setTableOrder(col);
        })
      });
  }

  $tableQueryParams.listen((tqp, changedKey)=>{
    console.log('Key changed: '+changedKey); // TODO: delete
    if (changedKey === 'query') {
    }
    if (changedKey) {
      refreshProductsTable();
    }
  });

</script>
